name: backtest-gates

on:
  workflow_dispatch:
    inputs:
      PROFIT_TARGET:
        description: "profit target (e.g. 0.10)"
        required: true
        default: "0.10"
      HOLDING_DAYS:
        description: "max holding days (e.g. 40)"
        required: true
        default: "40"
      STOP_LEVEL:
        description: "stop level (e.g. -0.10)"
        required: true
        default: "-0.10"
      MAX_EXTEND_DAYS:
        description: "tag only (ex: 30)"
        required: true
        default: "30"

      # ✅ 여러 값 실험(콤마로 구분)
      TAIL_MAX_LIST:
        description: "comma-separated tail thresholds (e.g. 0.15,0.25,0.35)"
        required: true
        default: "0.20,0.30"
      U_QUANTILE_LIST:
        description: "comma-separated utility quantiles (e.g. 0.60,0.75,0.90)"
        required: true
        default: "0.75,0.90"
      RANK_BY_LIST:
        description: "comma-separated rank metric (utility|ret_score|p_success). e.g. utility,ret_score"
        required: true
        default: "utility"

      LAMBDA_TAIL:
        description: "utility tail penalty lambda (e.g. 0.05)"
        required: true
        default: "0.05"

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      PROFIT_TARGET: ${{ inputs.PROFIT_TARGET }}
      HOLDING_DAYS: ${{ inputs.HOLDING_DAYS }}
      STOP_LEVEL: ${{ inputs.STOP_LEVEL }}
      MAX_EXTEND_DAYS: ${{ inputs.MAX_EXTEND_DAYS }}

      TAIL_MAX_LIST: ${{ inputs.TAIL_MAX_LIST }}
      U_QUANTILE_LIST: ${{ inputs.U_QUANTILE_LIST }}
      RANK_BY_LIST: ${{ inputs.RANK_BY_LIST }}
      LAMBDA_TAIL: ${{ inputs.LAMBDA_TAIL }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas scikit-learn joblib yfinance pyarrow

      # ---- 네 파이프라인 기본 스텝(이미 있으면 유지/조정) ----
      - name: Universe
        run: |
          python scripts/universe.py

      - name: Fetch prices (include market tickers)
        run: |
          python scripts/fetch_prices.py --include-extra --reset --force-full

      - name: Build features
        run: |
          python scripts/build_features.py

      - name: Build labels
        run: |
          python scripts/build_labels.py \
            --profit-target "${PROFIT_TARGET}" \
            --max-days "${HOLDING_DAYS}" \
            --stop-level "${STOP_LEVEL}"

      - name: Build strategy labels
        run: |
          python scripts/build_strategy_labels.py \
            --profit-target "${PROFIT_TARGET}" \
            --max-days "${HOLDING_DAYS}" \
            --stop-level "${STOP_LEVEL}" \
            --max-extend-days "${MAX_EXTEND_DAYS}"

      - name: Train success model
        run: |
          python scripts/train_model.py

      - name: Train strategy models (tail model etc)
        run: |
          python scripts/train_strategy_models.py

      # ---- ✅ 게이트 조합 실험 ----
      - name: Gate grid runs (none / tail / utility / tail_utility) x (lists)
        run: |
          set -euo pipefail

          PT="${PROFIT_TARGET}"
          H="${HOLDING_DAYS}"
          SL="${STOP_LEVEL}"
          EX="${MAX_EXTEND_DAYS}"
          LAM="${LAMBDA_TAIL}"

          # TAG 생성(파일명/머지용)
          python - <<PY
          pt=float("${PROFIT_TARGET}")
          h=int("${HOLDING_DAYS}")
          sl=float("${STOP_LEVEL}")
          ex=int("${MAX_EXTEND_DAYS}")
          pt_tag=int(round(pt*100))
          sl_tag=int(round(abs(sl)*100))
          tag=f"pt{pt_tag}_h{h}_sl{sl_tag}_ex{ex}"
          with open("${GITHUB_ENV}","a",encoding="utf-8") as f:
              f.write("TAG="+tag+"\\n")
          print("TAG="+tag)
          PY

          # 리스트 파싱(콤마 구분)
          IFS=',' read -ra TAILS <<< "${TAIL_MAX_LIST}"
          IFS=',' read -ra UQS   <<< "${U_QUANTILE_LIST}"
          IFS=',' read -ra RANKS <<< "${RANK_BY_LIST}"

          # 공백 트림 함수
          trim () { echo "$1" | xargs; }

          # 파일명 안전용(0.25 -> 0p25)
          safe () { echo "$1" | sed 's/\./p/g' | sed 's/-/m/g'; }

          run_one () {
            local MODE="$1"
            local TMAX="$2"
            local UQ="$3"
            local RANK="$4"

            local TMAX_T="$(safe "$(trim "$TMAX")")"
            local UQ_T="$(safe "$(trim "$UQ")")"
            local RANK_T="$(trim "$RANK")"

            local SUFFIX="${MODE}_t${TMAX_T}_q${UQ_T}_r${RANK_T}"

            echo ""
            echo "=============================="
            echo "[RUN] mode=${MODE} tail_max=${TMAX} u_q=${UQ} rank_by=${RANK} suffix=${SUFFIX}"
            echo "=============================="

            python scripts/predict_gate.py \
              --profit-target "${PT}" \
              --max-days "${H}" \
              --stop-level "${SL}" \
              --max-extend-days "${EX}" \
              --gate-mode "${MODE}" \
              --tail-max "$(trim "$TMAX")" \
              --u-quantile "$(trim "$UQ")" \
              --rank-by "${RANK_T}" \
              --lambda-tail "${LAM}" \
              --out-suffix "${SUFFIX}"

            python scripts/simulate_single_position_engine.py \
              --profit-target "${PT}" \
              --max-days "${H}" \
              --stop-level "${SL}" \
              --max-extend-days "${EX}" \
              --method custom \
              --pick-col pick_custom \
              --picks-path "data/signals/picks_${TAG}_gate_${SUFFIX}.csv" \
              --label "${SUFFIX}" \
              --out-suffix "${SUFFIX}" \
              --initial-seed 40000000
          }

          # ✅ baseline (none) — 1회만 (첫 값만 사용)
          BASE_T="${TAILS[0]}"
          BASE_Q="${UQS[0]}"
          for R in "${RANKS[@]}"; do
            run_one "none" "${BASE_T}" "${BASE_Q}" "${R}"
          done

          # ✅ tail gate — tail list만 loop (u는 첫 값 고정)
          for T in "${TAILS[@]}"; do
            for R in "${RANKS[@]}"; do
              run_one "tail" "${T}" "${BASE_Q}" "${R}"
            done
          done

          # ✅ utility gate — u list만 loop (tail은 첫 값 고정)
          for Q in "${UQS[@]}"; do
            for R in "${RANKS[@]}"; do
              run_one "utility" "${BASE_T}" "${Q}" "${R}"
            done
          done

          # ✅ tail + utility gate — cartesian (tail x u)
          for T in "${TAILS[@]}"; do
            for Q in "${UQS[@]}"; do
              for R in "${RANKS[@]}"; do
                run_one "tail_utility" "${T}" "${Q}" "${R}"
              done
            done
          done

      - name: Merge gate summaries
        run: |
          python scripts/merge_gate_summaries.py --tag "${TAG}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gate-results
          path: |
            data/signals/**
            data/features/**
            data/labels/**
            data/raw/**
            app/**
