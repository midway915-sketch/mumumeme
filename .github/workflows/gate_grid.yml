name: Gate Grid Backtest

on:
  workflow_dispatch:
    inputs:
      profit_target:
        description: "profit target (e.g. 0.10) OR list (e.g. 0.05,0.10,0.15)"
        required: true
        default: "0.10"
      max_holding_days:
        description: "max holding days (e.g. 40) OR list (e.g. 30,40,50)"
        required: true
        default: "40"
      stop_level:
        description: "stop level (e.g. -0.10) OR list (e.g. -0.05,-0.10,-0.15)"
        required: true
        default: "-0.10"
      max_extend_days:
        description: "extend horizon tag + strategy label horizon add (e.g. 30)"
        required: true
        default: "30"
      tail_max_list:
        description: "comma-separated p_tail thresholds (e.g. 0.15,0.25,0.35)"
        required: true
        default: "0.20,0.30"
      u_quantile_list:
        description: "comma-separated utility quantiles (e.g. 0.60,0.75,0.90)"
        required: true
        default: "0.75,0.90"
      rank_by_list:
        description: "comma-separated rank metric (utility|ret_score|p_success). e.g. utility,ret_score"
        required: true
        default: "utility"
      lambda_tail:
        description: "utility tail penalty lambda (e.g. 0.05)"
        required: true
        default: "0.05"
      rebuild_all:
        description: "true to rebuild prices/features/labels/models from scratch"
        required: true
        default: "false"

jobs:
  gate-grid:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip wheel setuptools
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install -U pyarrow

      - name: Prepare universe.csv
        shell: bash
        run: |
          set -euo pipefail
          if [ -f scripts/universe.py ]; then
            python scripts/universe.py
          else
            echo "[WARN] scripts/universe.py not found. Assuming data/universe.csv exists."
          fi

      - name: Fetch prices + Build base features (only once)
        shell: bash
        env:
          REBUILD_ALL: "${{ inputs.rebuild_all }}"
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}"

          if [ "${REBUILD_ALL}" = "true" ]; then
            python scripts/fetch_prices.py --include-extra --reset --force-full
          else
            python scripts/fetch_prices.py --include-extra
          fi

          python scripts/build_features.py

      - name: Run PT/H/SL grid + gate grid (reusable bash lib)
        shell: bash
        env:
          PROFIT_TARGET_INPUT: "${{ inputs.profit_target }}"
          HOLDING_DAYS_INPUT: "${{ inputs.max_holding_days }}"
          STOP_LEVEL_INPUT: "${{ inputs.stop_level }}"
          MAX_EXTEND_DAYS: "${{ inputs.max_extend_days }}"
          TAIL_MAX_LIST: "${{ inputs.tail_max_list }}"
          U_QUANTILE_LIST: "${{ inputs.u_quantile_list }}"
          RANK_BY_LIST: "${{ inputs.rank_by_list }}"
          LAMBDA_TAIL: "${{ inputs.lambda_tail }}"
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}"

          if [ ! -f scripts/gate_grid_lib.sh ]; then
            echo "[ERROR] scripts/gate_grid_lib.sh not found"
            exit 1
          fi
          source scripts/gate_grid_lib.sh

          trim(){ echo "$1" | xargs; }

          IFS=',' read -r -a PT_LIST <<< "${PROFIT_TARGET_INPUT}"
          IFS=',' read -r -a H_LIST  <<< "${HOLDING_DAYS_INPUT}"
          IFS=',' read -r -a SL_LIST <<< "${STOP_LEVEL_INPUT}"

          make_tag () {
            python -c "pt=float('${1}'); h=int('${2}'); sl=float('${3}'); ex=int('${4}'); \
            pt_tag=f'pt{int(round(pt*100))}'; sl_tag=f'sl{int(round(abs(sl)*100))}'; \
            print(f'{pt_tag}_h{h}_{sl_tag}_ex{ex}')"
                      }

          for PT in "${PT_LIST[@]}"; do
            PT="$(trim "${PT}")"
            for H in "${H_LIST[@]}"; do
              H="$(trim "${H}")"
              for SL in "${SL_LIST[@]}"; do
                SL="$(trim "${SL}")"

                export PROFIT_TARGET="${PT}"
                export HOLDING_DAYS="${H}"
                export STOP_LEVEL="${SL}"
                export TAG
                TAG="$(make_tag "${PT}" "${H}" "${SL}" "${MAX_EXTEND_DAYS}")"
                export TAG

                echo ""
                echo "===================================================="
                echo "[GRID] TAG=${TAG} (PT=${PT}, H=${H}, SL=${SL}, EX=${MAX_EXTEND_DAYS})"
                echo "===================================================="

                python scripts/build_labels.py \
                  --profit-target "${PT}" \
                  --max-days "${H}" \
                  --stop-level "${SL}" \
                  --max-extend-days "${MAX_EXTEND_DAYS}"

                python scripts/train_model.py

                if [ -f scripts/build_strategy_labels.py ] && [ -f scripts/train_strategy_models.py ]; then
                  python scripts/build_strategy_labels.py \
                    --profit-target "${PT}" \
                    --max-days "${H}" \
                    --stop-level "${SL}" \
                    --max-extend-days "${MAX_EXTEND_DAYS}"

                  python scripts/train_strategy_models.py \
                    --profit-target "${PT}" \
                    --max-days "${H}" \
                    --stop-level "${SL}" \
                    --max-extend-days "${MAX_EXTEND_DAYS}"
                else
                  echo "[WARN] strategy label/model scripts missing -> skipping"
                fi

                if [ -f app/tail_model.pkl ] && [ -f app/tail_scaler.pkl ]; then
                  export TAIL_OK=1
                else
                  export TAIL_OK=0
                fi

                run_gate_grid

                echo "=== DEBUG: list data/signals ==="
                ls -la data/signals || true
                
                echo "=== DEBUG: find any sim_engine_summary csvs (anywhere under data/) ==="
                find data -maxdepth 6 -type f -name "sim_engine_summary*.csv" -print || true
                
                python - <<'PY'
                import os, glob
                import pandas as pd
                
                tag = os.environ["TAG"]
                
                # ✅ data/signals만 보지 말고 data/** 전체에서 tag 포함 summary를 찾음
                paths = sorted([
                    p for p in glob.glob(f"data/**/sim_engine_summary*{tag}*.csv", recursive=True)
                    if "GATES_ALL" not in p
                ])
                
                # 혹시 tag가 파일명에 안 들어가는 케이스 대비: 방금 생성된 summary류 전부도 같이 잡아봄(너무 많으면 주석처리)
                if not paths:
                    paths = sorted([
                        p for p in glob.glob("data/**/sim_engine_summary*.csv", recursive=True)
                        if "GATES_ALL" not in p
                    ])
                
                # 그래도 없으면 즉시 에러 + 디버그
                if not paths:
                    raise SystemExit(f"[ERROR] No sim_engine_summary csv files found under data/** (tag={tag}). "
                                     f"Simulator may be writing elsewhere or not writing summary at all.")
                
                print("[INFO] summary candidates:", len(paths))
                for p in paths[:30]:
                    print("  -", p)
                
                dfs = []
                for p in paths:
                    try:
                        dfs.append(pd.read_csv(p))
                    except Exception as e:
                        print("[WARN] failed reading", p, "err=", e)
                
                if not dfs:
                    raise SystemExit(f"[ERROR] Found summary paths but none readable (tag={tag}).")
                
                df = pd.concat(dfs, ignore_index=True)
                
                # label 컬럼이 있으면 중복 제거(없으면 그냥 저장)
                if "label" in df.columns:
                    df = df.drop_duplicates(subset=["label"], keep="last")
                
                out = f"data/signals/sim_engine_summary_{tag}_GATES_ALL.csv"
                os.makedirs("data/signals", exist_ok=True)
                df.to_csv(out, index=False)
                print("[DONE] wrote", out, "rows=", len(df))
                PY
                
                # ✅ 이제 gate_summary 생성 가능
                python scripts/make_gate_summary.py --tag "${TAG}" --max-days "${H}" --recent-years 10

            done
          done

          python scripts/aggregate_gate_grid.py

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "gate-grid-results"
          retention-days: 14
          if-no-files-found: error
          path: |
            data/signals/gate_summary_*.csv
            data/signals/gate_grid_aggregate.csv
            data/signals/gate_grid_top_by_recent10y.csv
            data/signals/sim_engine_summary_*_GATES_ALL.csv
