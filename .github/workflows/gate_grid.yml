name: gate-grid

on:
  workflow_dispatch:
    inputs:
      profit_target:
        description: "profit target list (comma-separated). e.g. 0.10 or 0.08,0.10,0.12"
        required: true
        default: "0.10"
      max_holding_days:
        description: "max holding days list (comma-separated). e.g. 40 or 35,40,45"
        required: true
        default: "40"
      stop_level:
        description: "stop level list (comma-separated, negative). e.g. -0.10 or -0.08,-0.10,-0.12"
        required: true
        default: "-0.10"
      extend_horizon:
        description: "extend horizon tag + strategy label horizon add (e.g. 30)"
        required: true
        default: "30"
      p_tail_thresholds:
        description: "comma-separated p_tail thresholds. e.g. 0.15,0.25,0.35"
        required: true
        default: "0.20,0.30"
      utility_quantiles:
        description: "comma-separated utility quantiles. e.g. 0.60,0.75,0.90"
        required: true
        default: "0.75,0.90"
      rank_metric:
        description: "comma-separated rank metric (utility|ret_score|p_success|utility_time). e.g. utility,utility_time"
        required: true
        default: "utility,utility_time"
      utility_tail_penalty_lambda:
        description: "utility tail penalty lambda (e.g. 0.05)"
        required: true
        default: "0.05"
      rebuild_all:
        description: "true to rebuild prices/features/labels/models from scratch"
        required: true
        default: "false"

jobs:
  gate-grid:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance pyarrow scikit-learn joblib
          fi

      - name: Sanity check scripts exist
        shell: bash
        run: |
          set -euo pipefail
          ls -la scripts || true

          for f in \
            scripts/run_grid_workflow.sh \
            scripts/gate_grid_lib.sh \
            scripts/fetch_prices.py \
            scripts/build_features.py \
            scripts/build_labels.py \
            scripts/train_model.py \
            scripts/build_tau_labels.py \
            scripts/train_tau_model.py \
            scripts/predict_tau.py \
            scripts/predict_gate.py \
            scripts/simulate_single_position_engine.py \
            scripts/merge_sim_summaries.py \
            scripts/aggregate_gate_grid.py \
            scripts/universe.py
          do
            if [ ! -f "$f" ]; then
              echo "[ERROR] missing file: $f"
              exit 1
            fi
          done

          chmod +x scripts/run_grid_workflow.sh scripts/gate_grid_lib.sh || true

      - name: (Optional) Reset data
        if: ${{ inputs.rebuild_all == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          rm -rf data || true
          mkdir -p data/raw data/features data/labels data/signals app

      - name: Ensure universe.csv
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data
          python scripts/universe.py
          echo "[INFO] universe.csv head:"
          head -n 20 data/universe.csv || true

      - name: Fetch prices (include SPY/VIX)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/raw
          python scripts/fetch_prices.py --include-extra --force-full

      - name: Build features
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/features
          python scripts/build_features.py

      - name: Normalize features filename (ensure features_model.* exists)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/features

          if [ -f data/features/features_model.parquet ] || [ -f data/features/features_model.csv ]; then
            echo "[OK] features_model already exists"
            ls -la data/features | head -n 200 || true
            exit 0
          fi

          python - <<'PY'
          from pathlib import Path
          import shutil

          d = Path("data/features")
          cand_parq = sorted([p for p in d.glob("*.parquet") if "feature" in p.name.lower()])
          cand_csv  = sorted([p for p in d.glob("*.csv") if "feature" in p.name.lower()])

          def pick_best(paths):
              if not paths:
                  return None
              scored=[]
              for p in paths:
                  name=p.name.lower()
                  s=0
                  if "features_model" in name: s+=200
                  if "model" in name: s+=100
                  if "daily" in name: s+=10
                  try:
                      s += int(p.stat().st_size/1024)
                  except:
                      pass
                  scored.append((s,p))
              scored.sort(key=lambda x:x[0], reverse=True)
              return scored[0][1]

          src = pick_best(cand_parq) or pick_best(cand_csv)
          if src is None:
              raise SystemExit("[ERROR] No feature files found under data/features. build_features.py output missing?")

          dst = d / ("features_model.parquet" if src.suffix == ".parquet" else "features_model.csv")
          shutil.copy2(src, dst)
          print(f"[DONE] normalized features: {src} -> {dst}")
          PY

          ls -la data/features | head -n 200 || true

      - name: Run grid (Round-1 broad)
        shell: bash
        env:
          PROFIT_TARGET_INPUT: ${{ inputs.profit_target }}
          HOLDING_DAYS_INPUT: ${{ inputs.max_holding_days }}
          STOP_LEVEL_INPUT: ${{ inputs.stop_level }}
          MAX_EXTEND_DAYS: ${{ inputs.extend_horizon }}

          TAIL_MAX_LIST: ${{ inputs.p_tail_thresholds }}
          U_QUANTILE_LIST: ${{ inputs.utility_quantiles }}
          RANK_BY_LIST: ${{ inputs.rank_metric }}
          LAMBDA_TAIL: ${{ inputs.utility_tail_penalty_lambda }}

          TAU_GAMMA_LIST: "0.03,0.05,0.08"
        run: |
          set -euo pipefail
          bash scripts/run_grid_workflow.sh

      - name: Aggregate gate grid (Round-1)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/aggregate_gate_grid.py
          echo "[INFO] Round-1 outputs:"
          ls -la data/signals | tail -n 200 || true

      - name: Derive refine grid from Pareto Top30
        shell: bash
        run: |
          set -euo pipefail

          python - <<'PY'
          import os
          import pandas as pd
          from pathlib import Path

          sig = Path("data/signals")
          src = sig / "gate_grid_pareto4.csv"
          if not src.exists():
            src = sig / "gate_grid_pareto.csv"
          if not src.exists():
            raise SystemExit("[ERROR] No pareto csv found (gate_grid_pareto4.csv or gate_grid_pareto.csv).")

          df = pd.read_csv(src)
          if df.empty:
            raise SystemExit("[ERROR] pareto csv is empty.")

          if "eff_score4" in df.columns:
            df = df.sort_values("eff_score4", ascending=False)
          elif "eff_score" in df.columns:
            df = df.sort_values("eff_score", ascending=False)

          top = df.head(30).copy()

          def uniq_limit(vals, limit):
            out=[]
            for v in vals:
              if pd.isna(v): 
                continue
              if v not in out:
                out.append(v)
              if len(out) >= limit:
                break
            return out

          pts=[]; hs=[]; sls=[]
          for _, r in top.iterrows():
            pt = float(r.get("PT", float("nan")))
            h  = float(r.get("H", float("nan")))
            sl = float(r.get("SL", float("nan")))

            if pt == pt:
              pts += [max(0.01, pt-0.01), pt, pt+0.01]
            if h == h:
              h = int(h)
              hs += [max(5, h-5), h, h+5]
            if sl == sl:
              sls += [sl-0.05, sl, sl+0.05]

          pts = sorted(set(round(x,4) for x in pts if 0 < x < 1.0))[:12]
          hs  = sorted(set(int(x) for x in hs if x > 0))[:9]
          sls = sorted(set(round(x,4) for x in sls if x < 0))[:9]

          tails = uniq_limit([round(float(x),4) for x in top.get("tail_max", []) if pd.notna(x)], 8) or [0.20, 0.30]
          uqs   = uniq_limit([round(float(x),4) for x in top.get("u_quantile", []) if pd.notna(x)], 8) or [0.75, 0.90]
          ranks = uniq_limit([str(x) for x in top.get("rank_by", []) if pd.notna(x)], 6) or ["utility", "utility_time"]
          gams  = uniq_limit([round(float(x),4) for x in top.get("tau_gamma", []) if pd.notna(x)], 6) or [0.03, 0.05, 0.08]

          def join(vals): return ",".join(str(v) for v in vals)

          env_lines = [
            f"PROFIT_TARGET_INPUT_REFINE={join(pts)}",
            f"HOLDING_DAYS_INPUT_REFINE={join(hs)}",
            f"STOP_LEVEL_INPUT_REFINE={join(sls)}",
            f"TAIL_MAX_LIST_REFINE={join(tails)}",
            f"U_QUANTILE_LIST_REFINE={join(uqs)}",
            f"RANK_BY_LIST_REFINE={join(ranks)}",
            f"TAU_GAMMA_LIST_REFINE={join(gams)}",
          ]

          github_env = os.environ.get("GITHUB_ENV")
          if not github_env:
            raise SystemExit("[ERROR] GITHUB_ENV not set")
          with open(github_env, "a", encoding="utf-8") as f:
            for line in env_lines:
              f.write(line + "\n")

          print("[REFINE] derived:")
          for line in env_lines:
            print(" ", line)
          PY

      - name: Run grid (Round-2 refine)
        shell: bash
        env:
          PROFIT_TARGET_INPUT: ${{ env.PROFIT_TARGET_INPUT_REFINE }}
          HOLDING_DAYS_INPUT: ${{ env.HOLDING_DAYS_INPUT_REFINE }}
          STOP_LEVEL_INPUT: ${{ env.STOP_LEVEL_INPUT_REFINE }}
          MAX_EXTEND_DAYS: ${{ inputs.extend_horizon }}

          TAIL_MAX_LIST: ${{ env.TAIL_MAX_LIST_REFINE }}
          U_QUANTILE_LIST: ${{ env.U_QUANTILE_LIST_REFINE }}
          RANK_BY_LIST: ${{ env.RANK_BY_LIST_REFINE }}
          LAMBDA_TAIL: ${{ inputs.utility_tail_penalty_lambda }}

          TAU_GAMMA_LIST: ${{ env.TAU_GAMMA_LIST_REFINE }}
        run: |
          set -euo pipefail
          bash scripts/run_grid_workflow.sh

      - name: Aggregate gate grid (Final)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/aggregate_gate_grid.py
          echo "[INFO] Final outputs:"
          ls -la data/signals | tail -n 200 || true

      - name: Upload artifacts (signals + summaries)
        uses: actions/upload-artifact@v4
        with:
          name: gate-grid-results-${{ github.run_id }}
          if-no-files-found: warn
          path: |
            data/signals/gate_grid_*.csv
            data/signals/gate_summary_*.csv
            data/signals/picks_*.csv
            data/signals/sim_engine_*.parquet
            data/raw/prices*.*
            data/features/*.*
            data/labels/*.*
            data/raw_data.csv
            app/*.pkl