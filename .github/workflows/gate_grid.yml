name: Gate Grid Backtest

on:
  workflow_dispatch:
    inputs:
      profit_target:
        description: "profit target (e.g. 0.10) OR list (e.g. 0.05,0.10,0.15)"
        required: true
        default: "0.10"
      max_holding_days:
        description: "max holding days (e.g. 40) OR list (e.g. 30,40,50)"
        required: true
        default: "40"
      stop_level:
        description: "stop level (e.g. -0.10) OR list (e.g. -0.05,-0.10,-0.15)"
        required: true
        default: "-0.10"
      max_extend_days:
        description: "extend horizon tag + strategy label horizon add (e.g. 30)"
        required: true
        default: "30"
      tail_max_list:
        description: "comma-separated p_tail thresholds (e.g. 0.15,0.25,0.35)"
        required: true
        default: "0.20,0.30"
      u_quantile_list:
        description: "comma-separated utility quantiles (e.g. 0.60,0.75,0.90)"
        required: true
        default: "0.75,0.90"
      rank_by_list:
        description: "comma-separated rank metric (utility|ret_score|p_success). e.g. utility,ret_score"
        required: true
        default: "utility"
      lambda_tail:
        description: "utility tail penalty lambda (e.g. 0.05)"
        required: true
        default: "0.05"
      rebuild_all:
        description: "true to rebuild prices/features/labels/models from scratch"
        required: true
        default: "false"

jobs:
  gate-grid:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip wheel setuptools
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install -U pyarrow

      - name: Prepare universe.csv
        shell: bash
        run: |
          set -euo pipefail
          if [ -f scripts/universe.py ]; then
            python scripts/universe.py
          else
            echo "[WARN] scripts/universe.py not found. Assuming data/universe.csv exists."
          fi

      - name: Fetch prices + Build base features (only once)
        shell: bash
        env:
          REBUILD_ALL: "${{ inputs.rebuild_all }}"
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}"
          if [ "${REBUILD_ALL}" = "true" ]; then
            python scripts/fetch_prices.py --include-extra --reset --force-full
          else
            python scripts/fetch_prices.py --include-extra
          fi
          python scripts/build_features.py

      - name: Run grid (PT/H/SL + gate)
        shell: bash
        env:
          PROFIT_TARGET_INPUT: "${{ inputs.profit_target }}"
          HOLDING_DAYS_INPUT: "${{ inputs.max_holding_days }}"
          STOP_LEVEL_INPUT: "${{ inputs.stop_level }}"
          MAX_EXTEND_DAYS: "${{ inputs.max_extend_days }}"
          TAIL_MAX_LIST: "${{ inputs.tail_max_list }}"
          U_QUANTILE_LIST: "${{ inputs.u_quantile_list }}"
          RANK_BY_LIST: "${{ inputs.rank_by_list }}"
          LAMBDA_TAIL: "${{ inputs.lambda_tail }}"
        run: |
          set -euo pipefail
          bash scripts/run_grid_workflow.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "gate-grid-results"
          retention-days: 14
          if-no-files-found: warn
          path: |
            data/signals/gate_summary_*.csv
            data/signals/gate_grid_aggregate.csv
            data/signals/gate_grid_top_by_recent10y.csv
            data/**/sim_engine_summary*.csv
            data/signals/picks_*.csv
