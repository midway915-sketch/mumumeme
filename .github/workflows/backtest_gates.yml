name: backtest-gates

on:
  workflow_dispatch:
    inputs:
      PROFIT_TARGET:
        description: "profit target (e.g. 0.10)"
        required: true
        default: "0.10"
      HOLDING_DAYS:
        description: "max holding days (e.g. 40)"
        required: true
        default: "40"
      STOP_LEVEL:
        description: "stop level (e.g. -0.10)"
        required: true
        default: "-0.10"
      MAX_EXTEND_DAYS:
        description: "tag only (ex: 30)"
        required: true
        default: "30"

      TAIL_MAX_LIST:
        description: "comma-separated tail thresholds (e.g. 0.15,0.25,0.35)"
        required: true
        default: "0.20,0.30"
      U_QUANTILE_LIST:
        description: "comma-separated utility quantiles (e.g. 0.60,0.75,0.90)"
        required: true
        default: "0.75,0.90"
      RANK_BY_LIST:
        description: "comma-separated rank metric (utility|ret_score|p_success). e.g. utility,ret_score"
        required: true
        default: "utility"

      LAMBDA_TAIL:
        description: "utility tail penalty lambda (e.g. 0.05)"
        required: true
        default: "0.05"

      REFRESH_DATA:
        description: "true to rebuild prices/features/labels/models from scratch"
        required: true
        default: "false"

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      PROFIT_TARGET: ${{ inputs.PROFIT_TARGET }}
      HOLDING_DAYS: ${{ inputs.HOLDING_DAYS }}
      STOP_LEVEL: ${{ inputs.STOP_LEVEL }}
      MAX_EXTEND_DAYS: ${{ inputs.MAX_EXTEND_DAYS }}

      TAIL_MAX_LIST: ${{ inputs.TAIL_MAX_LIST }}
      U_QUANTILE_LIST: ${{ inputs.U_QUANTILE_LIST }}
      RANK_BY_LIST: ${{ inputs.RANK_BY_LIST }}
      LAMBDA_TAIL: ${{ inputs.LAMBDA_TAIL }}

      REFRESH_DATA: ${{ inputs.REFRESH_DATA }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-py311-v1

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas scikit-learn joblib yfinance pyarrow

      - name: Compute TAG
        run: |
          python - <<PY
          pt=float("${PROFIT_TARGET}")
          h=int("${HOLDING_DAYS}")
          sl=float("${STOP_LEVEL}")
          ex=int("${MAX_EXTEND_DAYS}")
          pt_tag=int(round(pt*100))
          sl_tag=int(round(abs(sl)*100))
          tag=f"pt{pt_tag}_h{h}_sl{sl_tag}_ex{ex}"
          with open("${GITHUB_ENV}","a",encoding="utf-8") as f:
              f.write("TAG="+tag+"\\n")
          print("TAG="+tag)
          PY

      # ✅ 디버그: scripts 폴더에 뭐가 있는지 로그로 박아두자(로컬 없이 확인 가능)
      - name: Debug list scripts
        run: |
          echo "=== scripts/ ==="
          ls -la scripts || true

      - name: Universe (if exists)
        run: |
          if [ -f scripts/universe.py ]; then
            python scripts/universe.py
          else
            echo "[WARN] scripts/universe.py not found (skip)"
          fi

      # ✅ 캐시: prices + features
      - name: Cache static data (prices/features)
        uses: actions/cache@v4
        with:
          path: |
            data/raw/prices.parquet
            data/raw/prices.csv
            data/raw/prices_meta.json
            data/features/**
          key: static-${{ runner.os }}-${{ hashFiles('scripts/fetch_prices.py','scripts/build_features.py','scripts/universe.py','data/universe.csv') }}-v2
          restore-keys: |
            static-${{ runner.os }}-

      # ✅ 캐시: labels + models (TAG 종속)
      - name: Cache param data (labels/models by TAG)
        uses: actions/cache@v4
        with:
          path: |
            data/labels/**
            app/model.pkl
            app/scaler.pkl
            app/tail_model.pkl
            app/tail_scaler.pkl
          key: param-${{ runner.os }}-${{ env.TAG }}-${{ hashFiles('scripts/build_labels.py','scripts/build_strategy_labels.py','scripts/train_model.py','scripts/train_strategy_models.py') }}-v2
          restore-keys: |
            param-${{ runner.os }}-${{ env.TAG }}-

      - name: Optional clean (refresh)
        run: |
          if [ "${REFRESH_DATA}" = "true" ]; then
            echo "[REFRESH] cleaning outputs..."
            rm -f data/raw/prices.parquet data/raw/prices.csv data/raw/prices_meta.json || true
            rm -rf data/features data/labels || true
            rm -f app/model.pkl app/scaler.pkl app/tail_model.pkl app/tail_scaler.pkl || true
          else
            echo "[REFRESH] false (skip clean)"
          fi

      - name: Fetch prices - if missing
        run: |
          if [ -f data/raw/prices.parquet ] || [ -f data/raw/prices.csv ]; then
            echo "[SKIP] prices already exist"
          else
            if [ ! -f scripts/fetch_prices.py ]; then
              echo "[ERROR] scripts/fetch_prices.py not found"
              exit 1
            fi
            python scripts/fetch_prices.py --include-extra --force-full
          fi

      - name: Build features - if missing
        run: |
          if [ -f data/features/features_model.parquet ] || [ -f data/features/features_model.csv ]; then
            echo "[SKIP] features_model already exists"
          else
            if [ ! -f scripts/build_features.py ]; then
              echo "[ERROR] scripts/build_features.py not found"
              exit 1
            fi
            python scripts/build_features.py
          fi

      # ✅ build_labels.py가 없으면 스킵 (네 에러 방지 포인트)
      - name: Build labels (optional) - if script exists
        run: |
          if [ -f scripts/build_labels.py ]; then
            echo "[RUN] build_labels.py"
            python scripts/build_labels.py \
              --profit-target "${PROFIT_TARGET}" \
              --max-days "${HOLDING_DAYS}" \
              --stop-level "${STOP_LEVEL}"
          else
            echo "[SKIP] scripts/build_labels.py not found"
          fi

      - name: Build strategy labels (optional) - if script exists
        run: |
          if [ -f scripts/build_strategy_labels.py ]; then
            echo "[RUN] build_strategy_labels.py"
            python scripts/build_strategy_labels.py \
              --profit-target "${PROFIT_TARGET}" \
              --max-days "${HOLDING_DAYS}" \
              --stop-level "${STOP_LEVEL}" \
              --max-extend-days "${MAX_EXTEND_DAYS}"
          else
            echo "[SKIP] scripts/build_strategy_labels.py not found"
          fi

      - name: Train success model (optional) - if script exists
        run: |
          if [ -f app/model.pkl ] && [ -f app/scaler.pkl ]; then
            echo "[SKIP] success model already exists"
          else
            if [ -f scripts/train_model.py ]; then
              echo "[RUN] train_model.py"
              python scripts/train_model.py
            else
              echo "[WARN] scripts/train_model.py not found"
            fi
          fi

      - name: Train tail model (optional) - if script exists
        run: |
          if [ -f app/tail_model.pkl ] && [ -f app/tail_scaler.pkl ]; then
            echo "[SKIP] tail model already exists"
          else
            if [ -f scripts/train_strategy_models.py ]; then
              echo "[RUN] train_strategy_models.py"
              python scripts/train_strategy_models.py
            else
              echo "[WARN] scripts/train_strategy_models.py not found"
            fi
          fi

      # ✅ gate 실행에 필요한 모델 확인(없으면 여기서 깔끔하게 종료)
      - name: Sanity check models for gating
        run: |
          if [ ! -f app/model.pkl ] || [ ! -f app/scaler.pkl ]; then
            echo "[ERROR] Missing app/model.pkl or app/scaler.pkl -> gate picks cannot run."
            echo "       Either add/train the success model, or adjust workflow to not use predict_gate.py."
            exit 1
          fi

          if [ -f app/tail_model.pkl ] && [ -f app/tail_scaler.pkl ]; then
            echo "TAIL_OK=1" >> $GITHUB_ENV
            echo "[INFO] tail model available"
          else
            echo "TAIL_OK=0" >> $GITHUB_ENV
            echo "[WARN] tail model not found -> tail gates will be skipped (tail, tail_utility)"
          fi

      - name: Gate grid runs
        run: |
          set -euo pipefail

          if [ ! -f scripts/predict_gate.py ]; then
            echo "[ERROR] scripts/predict_gate.py not found"
            exit 1
          fi
          if [ ! -f scripts/simulate_single_position_engine.py ]; then
            echo "[ERROR] scripts/simulate_single_position_engine.py not found"
            exit 1
          fi

          PT="${PROFIT_TARGET}"
          H="${HOLDING_DAYS}"
          SL="${STOP_LEVEL}"
          EX="${MAX_EXTEND_DAYS}"
          LAM="${LAMBDA_TAIL}"

          IFS=',' read -ra TAILS <<< "${TAIL_MAX_LIST}"
          IFS=',' read -ra UQS   <<< "${U_QUANTILE_LIST}"
          IFS=',' read -ra RANKS <<< "${RANK_BY_LIST}"

          trim () { echo "$1" | xargs; }
          safe () { echo "$1" | sed 's/\./p/g' | sed 's/-/m/g'; }

          run_one () {
            local MODE="$1"
            local TMAX="$2"
            local UQ="$3"
            local RANK="$4"

            local TMAX_T="$(safe "$(trim "$TMAX")")"
            local UQ_T="$(safe "$(trim "$UQ")")"
            local RANK_T="$(trim "$RANK")"

            local SUFFIX="${MODE}_t${TMAX_T}_q${UQ_T}_r${RANK_T}"

            echo ""
            echo "=============================="
            echo "[RUN] mode=${MODE} tail_max=${TMAX} u_q=${UQ} rank_by=${RANK} suffix=${SUFFIX}"
            echo "=============================="

            python scripts/predict_gate.py \
              --profit-target "${PT}" \
              --max-days "${H}" \
              --stop-level "${SL}" \
              --max-extend-days "${EX}" \
              --gate-mode "${MODE}" \
              --tail-max "$(trim "$TMAX")" \
              --u-quantile "$(trim "$UQ")" \
              --rank-by "${RANK_T}" \
              --lambda-tail "${LAM}" \
              --out-suffix "${SUFFIX}"

            python scripts/simulate_single_position_engine.py \
              --profit-target "${PT}" \
              --max-days "${H}" \
              --stop-level "${SL}" \
              --max-extend-days "${EX}" \
              --method custom \
              --pick-col pick_custom \
              --picks-path "data/signals/picks_${TAG}_gate_${SUFFIX}.csv" \
              --label "${SUFFIX}" \
              --out-suffix "${SUFFIX}" \
              --initial-seed 40000000
          }

          BASE_T="${TAILS[0]}"
          BASE_Q="${UQS[0]}"

          # baseline(none): 각 rank_by마다 1회
          for R in "${RANKS[@]}"; do
            run_one "none" "${BASE_T}" "${BASE_Q}" "${R}"
          done

          # tail gate / tail_utility는 tail 모델 있을 때만
          if [ "${TAIL_OK}" = "1" ]; then
            for T in "${TAILS[@]}"; do
              for R in "${RANKS[@]}"; do
                run_one "tail" "${T}" "${BASE_Q}" "${R}"
              done
            done
          else
            echo "[SKIP] tail gates skipped (TAIL_OK=0)"
          fi

          # utility gate
          for Q in "${UQS[@]}"; do
            for R in "${RANKS[@]}"; do
              run_one "utility" "${BASE_T}" "${Q}" "${R}"
            done
          done

          # tail + utility gate
          if [ "${TAIL_OK}" = "1" ]; then
            for T in "${TAILS[@]}"; do
              for Q in "${UQS[@]}"; do
                for R in "${RANKS[@]}"; do
                  run_one "tail_utility" "${T}" "${Q}" "${R}"
                done
              done
            done
          fi

      - name: Merge gate summaries (if script exists)
        run: |
          if [ -f scripts/merge_gate_summaries.py ]; then
            python scripts/merge_gate_summaries.py --tag "${TAG}"
          else
            echo "[WARN] scripts/merge_gate_summaries.py not found (skip merge)"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gate-results
          path: |
            data/signals/**
            data/features/**
            data/labels/**
            data/raw/**
            app/**
