name: gate-grid

on:
  workflow_dispatch:
    inputs:
      profit_target:
        description: "profit target (e.g. 0.10)"
        required: true
        default: "0.10"
      max_days:
        description: "max holding days (e.g. 40)"
        required: true
        default: "40"
      stop_level:
        description: "stop level (e.g. -0.10)"
        required: true
        default: "-0.10"
      max_extend_days:
        description: "extend horizon tag + strategy label horizon add (e.g. 30)"
        required: true
        default: "30"

      p_tail_thresholds:
        description: "comma-separated p_tail thresholds (e.g. 0.10,0.20,0.30)"
        required: true
        default: "0.10,0.20,0.30"
      utility_quantiles:
        description: "comma-separated utility quantiles (e.g. 0.60,0.75,0.90)"
        required: true
        default: "0.60,0.75,0.90"
      rank_metrics:
        description: "comma-separated rank metric (utility|ret_score|p_success)"
        required: true
        default: "utility,ret_score"

      lambda_tail:
        description: "utility tail penalty lambda (e.g. 0.05)"
        required: true
        default: "0.05"

      ps_min_thresholds:
        description: "comma-separated p_success min thresholds (e.g. 0.0,0.05,0.10)"
        required: true
        default: "0.0,0.05,0.10"

      max_leverage_pct:
        description: "max leverage pct cap (1.0=100%)"
        required: true
        default: "1.0"

      enable_trailing:
        description: "true/false"
        required: true
        default: "true"
      tp1_frac:
        description: "TP1 fraction (e.g. 0.50)"
        required: true
        default: "0.50"
      trail_stops:
        description: "comma-separated trailing stops (e.g. 0.08,0.10,0.12)"
        required: true
        default: "0.08,0.10,0.12"

      topk_configs:
        description: "TopK configs: '1|1.0;2|0.7,0.3;2|0.6,0.4'"
        required: true
        default: "1|1.0"

      rebuild_all:
        description: "true to rebuild prices/features/models from scratch"
        required: true
        default: "false"

  schedule:
    # 매일 한국시간 08:10 (UTC 23:10)
    - cron: "10 23 * * *"

jobs:
  grid:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance pyarrow scikit-learn joblib
          fi

      - name: Ensure folders
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/raw data/features data/labels data/signals data/meta app scripts

      - name: Set LABEL_KEY env (safe)
        shell: bash
        run: |
          set -euo pipefail
          pt="$(python - <<'PY'
          s="${{ inputs.profit_target }}"
          print(int(round(float(s)*100)))
          PY
          )"
                    md="${{ inputs.max_days }}"
                    sl="$(python - <<'PY'
          s="${{ inputs.stop_level }}"
          print(int(round(abs(float(s))*100)))
          PY
          )"
          ex="${{ inputs.max_extend_days }}"
          echo "LABEL_KEY=pt${pt}_h${md}_sl${sl}_ex${ex}" >> "$GITHUB_ENV"

      - name: Prepare (optional rebuild)
        shell: bash
        env:
          REBUILD_ALL: ${{ inputs.rebuild_all }}
        run: |
          set -euo pipefail
          if [ "$REBUILD_ALL" = "true" ]; then
            rm -f data/raw/prices.parquet data/raw/prices.csv data/raw/prices_meta.json || true
            rm -f data/features/features_model.parquet data/features/features_model.csv || true
            rm -f data/features/features_scored.parquet data/features/features_scored.csv || true
            rm -f data/features/features_scored_meta.json || true
            rm -f app/model.pkl app/scaler.pkl app/tail_model.pkl || true
            rm -rf data/signals/* || true
          fi

      # 1) prices
      - name: Build prices (incremental)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/universe.py
          if [ ! -f data/raw/prices.parquet ] && [ ! -f data/raw/prices.csv ]; then
            python scripts/fetch_prices.py --include-extra --reset --force-full
          else
            python scripts/fetch_prices.py --include-extra --lookback-days 10
          fi

      # 2) features_model
      - name: Build features_model (if missing)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f data/features/features_model.parquet ] && [ ! -f data/features/features_model.csv ]; then
            python scripts/build_features.py
          else
            echo "[INFO] features_model exists -> reuse"
          fi

      # 3) (optional) build/train models (you already have scripts; keep as-is or add your own)
      # NOTE: 여기서는 "존재하면 재사용"만 함. 없으면 터지지 않게 score_features에서 require 플래그를 조절 가능.
      - name: Score features -> features_scored
        shell: bash
        run: |
          set -euo pipefail
          python scripts/score_features.py \
            --features-parq data/features/features_model.parquet \
            --features-csv data/features/features_model.csv \
            --out-parq data/features/features_scored.parquet \
            --out-csv data/features/features_scored.csv \
            --success-model app/model.pkl \
            --success-scaler app/scaler.pkl \
            --tail-model app/tail_model.pkl \
            --lambda-tail "${{ inputs.lambda_tail }}" \
            --meta-out data/features/features_scored_meta.json

      - name: Validate pipeline (fail fast)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/validate_pipeline.py \
            --require-scored

      - name: Run gate grid (predict + simulate + summarize)
        shell: bash
        env:
          LABEL_KEY: ${{ env.LABEL_KEY }}
          PROFIT_TARGET: ${{ inputs.profit_target }}
          MAX_DAYS: ${{ inputs.max_days }}
          STOP_LEVEL: ${{ inputs.stop_level }}
          MAX_EXTEND_DAYS: ${{ inputs.max_extend_days }}

          P_TAIL_THRESHOLDS: ${{ inputs.p_tail_thresholds }}
          UTILITY_QUANTILES: ${{ inputs.utility_quantiles }}
          RANK_METRICS: ${{ inputs.rank_metrics }}
          LAMBDA_TAIL: ${{ inputs.lambda_tail }}
          PS_MIN_THRESHOLDS: ${{ inputs.ps_min_thresholds }}

          MAX_LEVERAGE_PCT: ${{ inputs.max_leverage_pct }}

          ENABLE_TRAILING: ${{ inputs.enable_trailing }}
          TP1_FRAC: ${{ inputs.tp1_frac }}
          TRAIL_STOPS: ${{ inputs.trail_stops }}

          TOPK_CONFIGS: ${{ inputs.topk_configs }}
          GATE_MODES: "none,tail,utility,tail_utility"

          OUT_DIR: "data/signals"
          EXCLUDE_TICKERS: "SPY,^VIX"
        run: |
          set -euo pipefail
          chmod +x scripts/run_grid_workflow.sh
          bash scripts/run_grid_workflow.sh

      - name: Aggregate summaries
        shell: bash
        run: |
          set -euo pipefail
          python scripts/aggregate_gate_grid.py \
            --signals-dir "data/signals" \
            --out-aggregate "data/signals/gate_grid_aggregate.csv" \
            --out-top "data/signals/gate_grid_top_by_recent10y.csv" \
            --pattern "gate_summary_*.csv" \
            --topn 50

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gate-grid-results
          path: |
            data/features/features_scored_meta.json
            data/signals/gate_summary_*.csv
            data/signals/gate_grid_aggregate.csv
            data/signals/gate_grid_top_by_recent10y.csv
            data/signals/picks_*.csv
            data/signals/sim_engine_trades_*.parquet
            data/signals/sim_engine_curve_*.parquet
          if-no-files-found: error