name: gate-grid

on:
  workflow_dispatch:
    inputs:
      profit_target:
        description: "profit target (e.g. 0.10)"
        required: true
        default: "0.10"
      max_days:
        description: "max holding days (e.g. 40)"
        required: true
        default: "40"
      stop_level:
        description: "stop level (e.g. -0.10)"
        required: true
        default: "-0.10"
      max_extend_days:
        description: "extend horizon tag + strategy label horizon add (e.g. 30)"
        required: true
        default: "30"
      p_tail_thresholds:
        description: "comma-separated p_tail thresholds (e.g. 0.15,0.25,0.35)"
        required: true
        default: "0.20,0.30"
      utility_quantiles:
        description: "comma-separated utility quantiles (e.g. 0.60,0.75,0.90)"
        required: true
        default: "0.75,0.90"
      rank_metrics:
        description: "comma-separated rank metric (utility|ret_score|p_success)"
        required: true
        default: "utility"
      lambda_tail:
        description: "utility tail penalty lambda (e.g. 0.05)"
        required: true
        default: "0.05"
      rebuild_all:
        description: "true to rebuild prices/features/labels/models from scratch"
        required: true
        default: "false"

jobs:
  grid:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance pyarrow scikit-learn joblib
          fi

      - name: Ensure folders
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/raw data/features data/labels data/signals app scripts

      # ✅ 핵심: "없으면 만들고, 있으면 재사용" + rebuild_all=true면 강제 재생성
      - name: Prepare required files (reuse if possible)
        shell: bash
        env:
          REBUILD_ALL: ${{ inputs.rebuild_all }}
        run: |
          set -euo pipefail

          prices_ok="false"
          feat_ok="false"
          model_ok="false"

          if [ -f data/raw/prices.parquet ] || [ -f data/raw/prices.csv ]; then prices_ok="true"; fi
          if [ -f data/features/features_model.parquet ] || [ -f data/features/features_model.csv ]; then feat_ok="true"; fi
          if [ -f app/model.pkl ] && [ -f app/scaler.pkl ]; then model_ok="true"; fi

          echo "[INFO] existing: prices_ok=$prices_ok feat_ok=$feat_ok model_ok=$model_ok"
          echo "[INFO] rebuild_all=$REBUILD_ALL"

          if [ "$REBUILD_ALL" = "true" ]; then
            echo "[INFO] rebuild_all=true -> force rebuild everything"
            rm -f data/raw/prices.parquet data/raw/prices.csv data/raw/prices_meta.json || true
            rm -f data/features/features_model.parquet data/features/features_model.csv || true
            rm -f data/labels/labels_model.parquet data/labels/labels_model.csv || true
            rm -f app/model.pkl app/scaler.pkl || true
            prices_ok="false"; feat_ok="false"; model_ok="false"
          fi

          # 1) prices
          if [ "$prices_ok" != "true" ]; then
            echo "[INFO] building prices..."
            python scripts/universe.py
            python scripts/fetch_prices.py --include-extra --reset --force-full
          else
            echo "[INFO] prices reuse"
          fi

          # 2) features_model
          if [ "$feat_ok" != "true" ]; then
            echo "[INFO] building features_model..."
            python scripts/build_features.py
          else
            echo "[INFO] features_model reuse"
          fi

          # 3) model.pkl/scaler.pkl (gate에서 p_success 쓰면 필수)
          if [ "$model_ok" != "true" ]; then
            echo "[INFO] building labels + training model..."
            python scripts/build_labels.py
            python scripts/train_model.py
          else
            echo "[INFO] model reuse"
          fi

          echo "[INFO] final check:"
          ls -la data/raw | sed -n '1,200p' || true
          ls -la data/features | sed -n '1,200p' || true
          ls -la app | sed -n '1,200p' || true

      - name: Run gate grid (predict + simulate + summarize)
        shell: bash
        env:
          PROFIT_TARGET: ${{ inputs.profit_target }}
          MAX_DAYS: ${{ inputs.max_days }}
          STOP_LEVEL: ${{ inputs.stop_level }}
          MAX_EXTEND_DAYS: ${{ inputs.max_extend_days }}
          P_TAIL_THRESHOLDS: ${{ inputs.p_tail_thresholds }}
          UTILITY_QUANTILES: ${{ inputs.utility_quantiles }}
          RANK_METRICS: ${{ inputs.rank_metrics }}
          LAMBDA_TAIL: ${{ inputs.lambda_tail }}
          TAU_GAMMA: "0.0"
          GATE_MODES: "none,tail,utility,tail_utility"
        run: |
          set -euo pipefail
          if [ ! -f scripts/run_grid_workflow.sh ]; then
            echo "[ERROR] scripts/run_grid_workflow.sh not found"
            exit 1
          fi
          chmod +x scripts/run_grid_workflow.sh || true
          bash scripts/run_grid_workflow.sh

      - name: Aggregate summaries
        shell: bash
        run: |
          set -euo pipefail
          python scripts/aggregate_gate_grid.py \
            --signals-dir "data/signals" \
            --out-aggregate "data/signals/gate_grid_aggregate.csv" \
            --out-top "data/signals/gate_grid_top_by_recent10y.csv" \
            --pattern "gate_summary_*.csv" \
            --topn 30

      - name: Sanity check (counts)
        shell: bash
        run: |
          set -euo pipefail
          echo "[CHECK] gate_summary count:"
          ls -1 data/signals/gate_summary_*.csv 2>/dev/null | wc -l || true
          echo "[CHECK] picks count:"
          ls -1 data/signals/picks_*.csv 2>/dev/null | wc -l || true
          echo "[CHECK] trades parquet count:"
          ls -1 data/signals/sim_engine_trades_*.parquet 2>/dev/null | wc -l || true
          echo "[CHECK] curve parquet count:"
          ls -1 data/signals/sim_engine_curve_*.parquet 2>/dev/null | wc -l || true
          echo "[CHECK] signals dir (first 200):"
          ls -la data/signals | sed -n '1,200p' || true

      - name: Upload artifacts (signals)
        uses: actions/upload-artifact@v4
        with:
          name: gate-grid-results
          path: |
            data/signals/gate_summary_*.csv
            data/signals/gate_grid_aggregate.csv
            data/signals/gate_grid_top_by_recent10y.csv
            data/signals/picks_*.csv
            data/signals/sim_engine_trades_*.parquet
            data/signals/sim_engine_curve_*.parquet
          if-no-files-found: error